<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Freelancer Dashboard — SkillConnect</title>
  <style>
    :root{
      --bg:#071019; --card:#0f1720; --muted:#99a8b0; --accent:#00d4a6; --accent2:#00b4ff;
    }
    html,body{height:100%;margin:0}
    body{
      background: linear-gradient(180deg,#041018,#071019);
      color:#eaf6f9;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      padding:28px;
    }

    .wrap { max-width:1000px; margin:0 auto; display:grid; grid-template-columns:1fr 360px; gap:20px; }
    header { grid-column:1/-1; display:flex; justify-content:space-between; align-items:center; margin-bottom:12px }
    h1{ color:var(--accent); margin:0; font-size:20px }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px; padding:18px; border:1px solid rgba(255,255,255,0.02);
      box-shadow:0 8px 30px rgba(0,0,0,0.5)
    }
    .jobs-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px }
    .job-card { padding:12px; border-radius:10px; background:#07111a; border:1px solid rgba(255,255,255,0.02) }
    .job-card h3{ margin:0 0 6px 0; color:#9fffe2 }
    .job-card p { margin:0 0 8px 0; color:var(--muted); font-size:13px }
    .btn { padding:8px 10px; border-radius:8px; border:none; cursor:pointer; font-weight:600; background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#042029 }
    .btn.ghost { background:transparent; border:1px solid rgba(255,255,255,0.03); color:var(--muted) }

    .sidebar { display:flex; flex-direction:column; gap:12px }
    .list { max-height:420px; overflow:auto; padding-right:6px }

    #message { margin-top:10px; font-weight:700 }

    @media (max-width:980px){
      .wrap { grid-template-columns:1fr; }
      .jobs-grid{ grid-template-columns:1fr }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>SkillConnect — Freelancer Dashboard</h1>
        <div style="color:var(--muted); font-size:13px">Browse jobs and apply — signed in as <strong>{{ username }}</strong></div>
      </div>
      <div>
        <button id="refresh" class="btn ghost">Refresh</button>
      </div>
    </header>

    <main class="card">
      <h2 style="margin:0 0 8px 0">Available Jobs</h2>
      <div style="color:var(--muted); margin-bottom:12px">Click <strong>I'm Interested</strong> to apply.</div>

      <div id="jobGrid" class="jobs-grid">
        <!-- jobs will be inserted here -->
      </div>

      <div id="message" aria-live="polite"></div>
    </main>

    <aside class="card sidebar">
      <h3 style="margin:0 0 8px 0">My Applications</h3>
      <div id="applicationsList" class="list">
        <div style="color:var(--muted)">Loading…</div>
      </div>

      <h3 style="margin:12px 0 8px 0">Notifications</h3>
      <div id="notes" class="list" style="color:var(--muted)">No notifications yet.</div>
    </aside>
  </div>

<script>
/*
  Freelancer Dashboard JS
  Uses API endpoints:
    GET  /api/jobs/                    -> list all jobs
    POST /api/jobs/<id>/apply/         -> apply to job   (body: { username: "<freelancer>" })
    GET  /api/freelancer/<username>/applications/  -> list my applications (if available)
    GET  /api/jobs/<id>/applications/  -> view applications (recruiter)
*/

const username = "{{ username }}";
const jobGrid = document.getElementById('jobGrid');
const msg = document.getElementById('message');
const appsBox = document.getElementById('applicationsList');
const notesBox = document.getElementById('notes');

async function getJSON(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error('Network error');
  return await r.json();
}
async function postJSON(url, body){
  const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  const data = await r.json();
  if(!r.ok) throw data;
  return data;
}

async function loadJobs(){
  jobGrid.innerHTML = '<div style="grid-column:1/-1;color:var(--muted)">Loading jobs…</div>';
  try {
    const jobs = await getJSON('/api/jobs/');
    if(!jobs.length){
      jobGrid.innerHTML = '<div style="grid-column:1/-1;color:var(--muted)">No jobs available.</div>';
      return;
    }
    jobGrid.innerHTML = '';
    jobs.forEach(job => {
      const div = document.createElement('div');
      div.className = 'job-card';
      div.innerHTML = `
        <h3>${escapeHtml(job.title)}</h3>
        <p><small><b>Stack:</b> ${escapeHtml(job.tech_stack)} • <b>Exp:</b> ${escapeHtml(job.experience_level)}</small></p>
        <p class="desc">${escapeHtml(job.description || '')}</p>
        <div style="display:flex; gap:8px; margin-top:8px">
          <button class="btn" onclick="apply(${job.id}, this)">I'm Interested</button>
          <button class="btn ghost" onclick="viewDetails(${job.id})">Details</button>
        </div>
      `;
      jobGrid.appendChild(div);
    });
  } catch(err){
    jobGrid.innerHTML = '<div style="grid-column:1/-1;color:#ff6b6b">Failed to load jobs</div>';
    console.error(err);
  }
}

async function apply(jobId, btn){
  btn.disabled = true;
  msg.style.color = '#9fffdc';
  msg.textContent = 'Applying…';
  try {
    const res = await postJSON(`/api/jobs/${jobId}/apply/`, { username });
    msg.style.color = '#9fffdc';
    msg.textContent = res.message || 'Application submitted';
    loadMyApplications();
  } catch(err){
    msg.style.color = '#ff6b6b';
    msg.textContent = (err && err.error) || 'Failed to apply';
    console.error(err);
  } finally {
    btn.disabled = false;
    setTimeout(()=> msg.textContent = '', 3500);
  }
}

async function loadMyApplications(){
  appsBox.innerHTML = '<div style="color:var(--muted)">Loading…</div>';
  try {
    const apps = await getJSON(`/api/freelancer/${username}/applications/`);
    if(!apps.length){ appsBox.innerHTML = '<div style="color:var(--muted)">No applications yet.</div>'; return; }
    appsBox.innerHTML = '';
    apps.forEach(a => {
      const el = document.createElement('div');
      el.style.padding = '8px';
      el.style.marginBottom = '8px';
      el.style.borderRadius = '8px';
      el.style.background = '#081218';
      el.innerHTML = `<div style="font-weight:700">${escapeHtml(a.job_title)}</div>
                      <div style="color:var(--muted); font-size:13px">Status: ${a.status} • Applied: ${a.applied_at}</div>`;
      appsBox.appendChild(el);
    });
  } catch(err){
    appsBox.innerHTML = '<div style="color:#ff6b6b">Failed to load</div>';
    console.error(err);
  }
}

async function loadNotifications(){
  // Optional: change endpoint if different
  try {
    const notes = await getJSON(`/api/recruiter/notifications/${username}/`); // if you have a notifications API for freelancer, update this
    if(!Array.isArray(notes) || notes.length===0){ notesBox.innerHTML='<div style="color:var(--muted)">No notifications</div>'; return; }
    notesBox.innerHTML = '';
    notes.forEach(n => {
      const item = document.createElement('div');
      item.style.padding = '8px';
      item.style.marginBottom = '8px';
      item.style.borderRadius = '8px';
      item.style.background = '#071116';
      item.innerHTML = `<div style="font-size:13px">${escapeHtml(n.message)}</div><div class="small" style="color:var(--muted);font-size:12px">${n.created_at}</div>`;
      notesBox.appendChild(item);
    });
  } catch(e){
    notesBox.innerHTML = '<div style="color:var(--muted)">No notifications</div>';
    // it's OK if your backend doesn't expose notifications yet
  }
}

function viewDetails(jobId) {
    window.location.href = `/job/${jobId}/`;
}


function escapeHtml(s){
  if(!s) return '';
  return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
}

document.getElementById('refresh').addEventListener('click', ()=> { loadJobs(); loadMyApplications(); loadNotifications(); });

loadJobs();
loadMyApplications();
loadNotifications();
</script>
</body>
</html>
