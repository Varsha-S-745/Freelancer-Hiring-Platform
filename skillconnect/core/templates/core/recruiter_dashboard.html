<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recruiter Dashboard — SkillConnect</title>
  <style>
    :root {
      --bg: #0f1720;
      --card: #10141a;
      --muted: #9aa6b2;
      --accent: #00d4a6;
      --accent-2: #00b4ff;
      --danger: #ff6b6b;
      color-scheme: dark;
    }
    html,body{height:100%;margin:0}
    body {
      background: linear-gradient(180deg,#071019 0%, #0f1720 100%);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: #e6eef3;
      padding: 28px;
      box-sizing: border-box;
    }
    .shell {
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 24px;
      align-items: start;
    }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 6px 22px rgba(2,6,23,0.6);
      border: 1px solid rgba(255,255,255,0.03);
    }

    header.card {
      grid-column: 1 / -1;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    h1 { margin: 0; font-size: 20px; letter-spacing: 0.2px; color: var(--accent); }
    .sub { color: var(--muted); font-size: 13px; margin-top:6px }

    form .row{display:grid;grid-template-columns:1fr 120px;gap:10px;margin-bottom:10px}
    input, textarea, select {
      width:100%;
      padding:10px 12px;
      background: rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.03);
      color: #eaf6f9;
      border-radius:8px;
      font-size:14px;
      outline:none;
    }
    textarea { min-height:86px; resize:vertical; }

    .btn {
      display:inline-block;
      padding:10px 14px;
      background: linear-gradient(90deg,var(--accent),var(--accent-2));
      color:#042029;
      border-radius:10px;
      font-weight:600;
      border:none;
      cursor:pointer;
    }
    .btn.ghost {
      background:transparent;
      border:1px solid rgba(255,255,255,0.04);
      color:var(--muted);
    }

    .jobs-list { display:flex; flex-direction:column; gap:12px; margin-top:14px }
    .job-item {
      padding:14px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
      border:1px solid rgba(255,255,255,0.02);
      display:flex; justify-content:space-between; gap:12px; align-items:flex-start;
    }
    .job-meta { flex:1; min-width:0 }
    .job-title { margin:0 0 6px 0; font-size:16px; color:#dffbf0 }
    .job-desc { margin:0; color:var(--muted); font-size:13px; line-height:1.4 }
    .job-right { display:flex; flex-direction:column; gap:8px; align-items:flex-end }

    .small { font-size:12px; color:var(--muted) }
    .apps-box { margin-top:8px; background:#071018; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.02) }
    .app-item { padding:8px; background:#08121a; border-radius:6px; margin-bottom:8px; display:flex; justify-content:space-between; gap:10px; align-items:center }
    .status { padding:6px 8px; border-radius:6px; font-weight:600; font-size:12px }
    .status.pending { background:#222; color:#e0e0e0 }
    .status.accept { background:#113f24; color:#8fffbf }
    .status.reject { background:#3b1216; color:#ffb4b4 }

    .note { color:var(--muted); font-size:13px }
    .response { margin-top:8px; font-weight:600 }

    @media (max-width:980px){
      .shell { grid-template-columns: 1fr; padding-bottom:60px }
      header.card{flex-direction:column;align-items:flex-start}
      .job-right { align-items:flex-start }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="card">
      <div>
        <h1>SkillConnect — Recruiter Dashboard</h1>
        <div class="sub">Post jobs, view applications, accept / reject candidates</div>
      </div>
      <div style="text-align:right">
        <div class="small">Signed in as</div>
        <div style="font-weight:700; color:#cfeee6">{{ username }}</div>
      </div>
    </header>

    <!-- Left column: Post job + Jobs list -->
    <section class="card">
      <h2 style="margin:0 0 8px 0">Post a New Job</h2>
      <div class="sub">Fill details and click <strong>Post Job</strong></div>

      <form id="postJobForm" style="margin-top:12px">
        <div class="row">
          <input id="title" name="title" placeholder="Job title (e.g. Django Developer)" required />
          <input id="pay_per_hour" name="pay_per_hour" placeholder="Pay/hr" type="number" min="0" />
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px">
          <input id="tech_stack" name="tech_stack" placeholder="Tech stack (comma separated)" />
          <input id="experience_level" name="experience_level" placeholder="Experience level (e.g. Mid)" />
        </div>

        <textarea id="description" name="description" placeholder="Job description (optional)"></textarea>

        <div style="margin-top:12px; display:flex; gap:8px; align-items:center">
          <button class="btn" type="submit">Post Job</button>
          <button id="refreshJobs" class="btn ghost" type="button">Refresh jobs</button>
          <div id="postResponse" class="response" aria-live="polite"></div>
        </div>
      </form>

      <hr style="border:none; height:1px; background:rgba(255,255,255,0.02); margin:18px 0">

      <h3 style="margin:0 0 8px 0">Your latest jobs</h3>
      <div class="jobs-list" id="jobsList">
        <!-- populated by JS -->
      </div>
      <div id="jobsNote" class="note" style="margin-top:10px">Tip: Click “View Applications” to manage candidates.</div>
    </section>

    <!-- Right column: Notifications & Quick info -->
    <aside class="card">
      <h3 style="margin:0 0 8px 0">Quick actions</h3>
      <div class="note" style="margin-bottom:12px">You can manage applicants from each job card.</div>

      <div style="margin-bottom:12px">
        <button id="loadAllJobs" class="btn" style="width:100%">Load all jobs</button>
      </div>

      <div style="margin-top:12px">
        <h4 style="margin:0 0 6px 0">Recent activity</h4>
        <div id="activity" class="note">No recent activity yet.</div>
      </div>

    </aside>
  </div>

<script>
/*
  Recruiter dashboard JS
  - Uses these API endpoints (update if yours differ):
    GET  /api/jobs/                       -> list all jobs
    POST /api/jobs/create/                -> create job  (body includes recruiter_username)
    GET  /api/jobs/<id>/applications/     -> list applications for job
    POST /api/applications/<id>/status/   -> update application status (Accepted/Rejected)
*/

const username = "{{ username }}"; // templated by Django

async function apiGet(url){ const r=await fetch(url); return r.ok? await r.json(): Promise.reject(await r.text()); }
async function apiPost(url, body){
  const r=await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  return r.ok? await r.json() : Promise.reject(await r.json());
}

const jobsListEl = document.getElementById('jobsList');
const postResponse = document.getElementById('postResponse');

async function loadJobs(){
  jobsListEl.innerHTML = '<div class="small">Loading jobs…</div>';
  try {
    const jobs = await apiGet('/api/jobs/');
    // show only those posted by this recruiter
    const myJobs = jobs.filter(j=> j.recruiter === username);
    if(!myJobs.length){
      jobsListEl.innerHTML = '<div class="small">You have not posted any jobs yet.</div>';
      return;
    }
    jobsListEl.innerHTML = '';
    myJobs.forEach(job => {
      const item = document.createElement('div');
      item.className = 'job-item';
      item.innerHTML = `
        <div class="job-meta">
          <div class="job-title">${escapeHtml(job.title)}</div>
          <div class="job-desc">${escapeHtml(job.description || '')}</div>
          <div class="small" style="margin-top:8px">Tech: ${escapeHtml(job.tech_stack)} · Pay/hr: ${job.pay_per_hour} · Posted: ${job.created_at}</div>
        </div>
        <div class="job-right">
          <button class="btn ghost" data-jobid="${job.id}" onclick="toggleApplications(this)">View Applications</button>
          <div style="width:100%; margin-top:8px" id="apps-${job.id}" class="apps-box" hidden></div>
        </div>
      `;
      jobsListEl.appendChild(item);
    });
  } catch(err){
    jobsListEl.innerHTML = `<div class="small" style="color:${'#ff6b6b'}">Error loading jobs</div>`;
    console.error(err);
  }
}

async function toggleApplications(btn){
  const jobId = btn.dataset.jobid;
  const box = document.getElementById('apps-' + jobId);
  if(!box) return;
  if(box.hidden){
    box.innerHTML = '<div class="small">Loading applications…</div>';
    box.hidden = false;
    try {
      const apps = await apiGet(`/api/jobs/${jobId}/applications/`);
      if(!apps.length) { box.innerHTML = '<div class="small">No applications yet.</div>'; return; }
      let html = '';
      apps.forEach(a=>{
        html += `<div class="app-item">
            <div style="min-width:0">
              <div style="font-weight:700">${escapeHtml(a.freelancer)}</div>
              <div class="small">Applied: ${a.applied_at}</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center">
              <div class="status ${a.status === 'Pending' ? 'pending' : (a.status === 'Accepted' ? 'accept' : 'reject')}">${a.status}</div>
              <div style="display:flex; gap:6px">
                <button class="btn" style="padding:6px 8px" onclick="updateStatus(${a.application_id}, 'Accepted')">Accept</button>
                <button class="btn ghost" style="padding:6px 8px" onclick="updateStatus(${a.application_id}, 'Rejected')">Reject</button>
              </div>
            </div>
          </div>`;
      });
      box.innerHTML = html;
    } catch(e){
      box.innerHTML = '<div class="small" style="color:#ff6b6b">Failed to load applications</div>';
      console.error(e);
    }
  } else {
    box.hidden = true;
  }
}

async function updateStatus(applicationId, newStatus){
  if(!confirm(`Mark application ${applicationId} as ${newStatus}?`)) return;
  try {
    const res = await apiPost(`/api/applications/${applicationId}/status/`, { status: newStatus });
    alert(res.message || 'Updated');
    loadJobs();
  } catch(err){
    alert((err && err.error) || 'Failed to update status');
    console.error(err);
  }
}

// Post job
document.getElementById('postJobForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  postResponse.textContent = 'Posting...';
  const payload = {
    recruiter_username: username,
    title: document.getElementById('title').value.trim(),
    pay_per_hour: document.getElementById('pay_per_hour').value,
    tech_stack: document.getElementById('tech_stack').value.trim(),
    experience_level: document.getElementById('experience_level').value.trim(),
    description: document.getElementById('description').value.trim()
  };
  try {
    const result = await apiPost('/api/jobs/create/', payload);
    postResponse.style.color = '#9fffdc';
    postResponse.textContent = result.message || 'Job posted';
    document.getElementById('postJobForm').reset();
    loadJobs();
  } catch(err){
    postResponse.style.color = '#ff6b6b';
    postResponse.textContent = (err && err.error) || 'Failed to post job';
    console.error(err);
  }
});

// refresh buttons
document.getElementById('refreshJobs').addEventListener('click', loadJobs);
document.getElementById('loadAllJobs').addEventListener('click', loadJobs);

function escapeHtml(s){
  if(!s) return '';
  return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
}

// initial load
loadJobs();
</script>
</body>
</html>
